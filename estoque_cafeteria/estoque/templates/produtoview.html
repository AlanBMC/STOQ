{% extends 'base.html' %}
{% block title %}Cadastros{% endblock %}

{% block content %}
<style> 
    /* Botões estilizados */
button {
    color: rgb(0, 0, 0);
    font-size: 18px;
    padding: 12px 20px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    text-align: center;
    gap: 8px;
    transition: all 0.3s ease-in-out;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    justify-content: center; /* Centraliza o texto e o ícone */

}



/* Ajuste de tamanho para diferentes telas */
@media (max-width: 1024px) {  /* Tablets */
    button {
        font-size: 16px;
        padding: 10px 18px;
    }
    .main-tabela{
        height: 322px;
    }
}

@media (max-width: 768px) {  /* Celulares */
    button {
        font-size: 14px;
        padding: 8px 16px;
    }
    .main-tabela{
        height: 302px;
    }
}

/* Ajustes para a tabela */
table {
    border-collapse: collapse;
    width: 100%;
}

/* Garante que os textos da tabela fiquem visíveis */
th, td {
    color: #333; /* Cor escura para melhor visibilidade */
}

/* Mantém cabeçalho fixo e bem destacado */


/* Melhora a usabilidade na rolagem */
tbody {
    background-color: #ffffff;
}



</style>





<div class="button-container flex flex-wrap justify-center  " style=" display: flex; justify-content: center; align-items: center; flex-wrap: wrap;">
    <button id="openModalBtn" class="bg-color-1 text-color-3 m-3 shadow-md hover:bg-opacity-90 transition-all">
        <i class="fas fa-plus mr-2"></i> Criar Produto
    </button>
   
    <button onclick="abrirModalCategoria()" class="bg-color-1 text-color-3 m-3 shadow-md hover:bg-opacity-90 transition-all">
        <i class="fas fa-plus mr-2"></i> Criar Categoria
    </button>
{%if is_proprietario %}
<button onclick="AbrirModalLoja()"
    class="bg-color-1 text-color-3 m-3 shadow-md hover:bg-opacity-90 transition-all">
    <i class="fas fa-plus mr-2"></i> Ver lojas
</button>
{%endif%}
   

</div>
<div class="flex justify-center md:justify-start items-center gap-3 mb-4">
    <input type="text" id="searchInput" placeholder="Buscar produto..."
        class="p-2 border rounded-lg w-64 focus:ring-2 focus:ring-blue-500 text-gray-800"
        onkeyup="buscarProduto()">
</div>

<div class="overflow-x-auto max-h-96 overflow-y-auto 
 border-gray-300 rounded-lg  border-black rounded-lg bg-white main-tabela"
  style="background-color: transparent; border: none">
    <table class="min-w-full bg-white shadow-md rounded-lg" style="background-color: #ffffff; 
    box-shadow: 1px 1px 1px rgba(0, 0, 0, 0.411), -1px -1px 1px rgba(0, 0, 0, 0.951);">
        <thead class="bg-gray-100 sticky top-0 border rounded-t-lg" style="box-shadow: 1px 1px 1px rgba(0, 0, 0, 0.411), -1px -1px 1px rgba(0, 0, 0, 0.951);">
            <tr class="text-gray-700" style="background-color: #fffffff8;box-shadow: 1px 1px 1px rgba(0, 0, 0, 0.411), -1px -1px 1px rgba(0, 0, 0, 0.951); ">
                <th class="py-3 px-6 text-left">ID</th>
                <th class="py-3 px-6 text-left">Nome</th>
                <th class="py-3 px-6 text-left">Quantidade</th>
            </tr>
        </thead>
        <tbody id="productTableBody" class="divide-y " style=" box-shadow: 1px 1px 1px rgba(0, 0, 0, 0.411), -1px -1px 1px rgba(0, 0, 0, 0.951);">
            {% for produto in produtos %}
            <tr class="cursor-pointer hover:bg-gray-200 transition-all border divide-black"  style=" box-shadow: 1px 1px 1px rgba(0, 0, 0, 0.411), -1px -1px 1px rgba(0, 0, 0, 0.951);"
                onclick="openEditModal('{{ produto.id }}', '{{ produto.nome }}', 
                '{{ produto.quantidade }}','{{ produto.tipo_quantidade }}',
                 '{{ produto.validade }}','{{ produto.categoria }}',
                 '{{ produto.estoque_minimo }}', '{{ produto.status }}')">
                <td  class="py-2 px-6">{{ produto.id }}</td>
                <td class="py-2 px-6">{{ produto.nome }}</td>
                <td class="py-2 px-6">{{ produto.quantidade }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Modal de Edição -->
<div id="editProductModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex justify-center items-center z-50">
    <div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full relative" style="    bottom: 60px;
">
        <button class="absolute top-2 right-3 text-gray-800 text-xl" style="background:transparent;"  onclick="closeEditModal()">&times;</button>
        
        <h2 class="text-2xl text-gray-800 font-semibold mb-4">Editar Produto</h2>

        <form method="post" action="{% url 'editar_produto' %}">
            {% csrf_token %}
            <input type="hidden" id="editProductId" name="produto_id">
            <!-- nome e quantidade -->
            <div class="flex space-x-4">
                <div class="mb-4 w-1/2">
                    <label class="block text-gray-700">Nome:</label>
                    <input type="text" required id="editProductName" name="nome"
                        class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="mb-4 w-1/3">
                    <label class="block text-gray-700">Quantidade:</label>
                    <input type="number" required id="editProductQuantity" step="0.001" min="1" name="quantidade"
                        class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                
            </div>
        <!-- tipo quantidade e estoque minimo-->
            <div class="flex space-x-4">
                <div class="mb-4 w-1/2">
                    <label for="tipo_quantidade" class="block text-gray-700">Tipo de Quantidade:</label>
                    <select id="editProductTipoQuantidade" name="tipo_quantidade" required
                        class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="UN">Unidade</option>
                        <option value="L">Litro</option>
                        <option value="KG">Quilograma</option>
                        <option value="G">Grama</option>
                        <option value="PCT">Pacote</option>
                    </select>
                </div>
              
                <div class="mb-4 w-1/2">
                    <label class="block text-gray-700">Estoque Mínimo:</label>
                    <input type="number" id="editProductEstoqueMin" required step="1" min="1"  name="estoque_min"
                        class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            <!-- validade  e status -->
            <div class="flex space-x-4">
            <div class="mb-4">
                <label class="block text-gray-700">Validade:</label>
                <input type="date" min="{{ today|date:'Y-m-d' }}" id="editProductValidade" name="validade"
                    class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>
        
            <div class="mb-4">
                <label class="block text-gray-700">Status:</label>
                <select id="editProductStatus" name="status" required
                    class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="em_uso">Em Uso</option>
                    <option value="estoque">Em Estoque</option>
                </select>
            </div>
        </div>
        <!-- categoria-->
            <div class="mb-4">
                <label class="block text-gray-700">Categoria:</label>
                <select id="editProductCategoria" name="Categoria" required
                    class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    {% for categoria in categorias %}
                    <option value="{{ categoria.id }}">{{ categoria.nome }}</option>
                    {% endfor %}
                </select>
            </div>
        
            <div class="flex justify-end">
                <button type="submit"
                    class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition">
                    Atualizar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal (inicialmente oculto) -->
<div id="productModal" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center z-50">
    <div class="max-w-lg mx-auto bg-color-3 rounded-lg shadow-lg p-6 relative" style="bottom:50px;">
        <a id="closeModalBtn" class="absolute top-3 right-3 text-color-4 text-xl">&times;</a>
        
        <h2 class="text-2xl color-5 font-semibold mb-4 color-1">Criar Produto</h2>
        
        <form method="post" action="{% url 'criar_produto'%}">
            {% csrf_token %}
            
            <div class="mb-4">
                <label for="nome" class="block text-color-4 text-sm font-semibold mb-2">Nome do Produto</label>
                <input type="text" id="nome" name="nome" required
                    class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-color-1">
            </div>


            <div class="flex space-x-4">
                <!-- Campo de Quantidade -->
                <div class="w-1/2">
                    <label for="quantidade" class="block text-color-4 text-sm font-semibold mb-2">Quantidade</label>
                    <input type="number" id="quantidade" name="quantidade" required step="1" min="1"
                        class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-color-1">
                </div>
                
                <!-- Campo de Tipo de Quantidade -->
                <div class="w-1/2">
                    <label for="tipo_quantidade" class="block text-color-4 text-sm font-semibold mb-2">Tipo de Quantidade</label>
                    <select id="tipo_quantidade" name="tipo_quantidade" required
                            class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-color-1">

                        <option value="UN">Unidade</option>
                        <option value="L">Litro</option>
                        <option value="KG">Quilograma</option>
                        <option value="G">Grama</option>
                        <option value="PCT">Pacote</option>
                    </select>
                </div>
            </div>
            

           
            
            <div class="flex space-x-4 mt-3" >
                <div class="w-1/2" id="validadepop">
                    <label for="Validade" class="block text-color-4 text-sm font-semibold mb-2">Validade</label>
                    <input type="date" min="{{ today|date:'Y-m-d' }}"  id="validade" name="validade" required
                        class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-color-1">
                </div>
                <div class="w-1/2" id="estoqueMin">
                    <label for="quantidade" class="block text-color-4 text-sm font-semibold mb-2">Quantidade min em estoque</label>
                    <input type="number" id="estoque_min" name="estoque_min" required  step="0.001" min="1"
                        class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-color-1">
                </div>
    
            </div>
            <div class="flex space-x-4" style="margin: 5px;">
    
                
                
                <!-- Categoria -->
                <div class="w-1/2">
                    <label for="Categoria" class="block text-color-4 text-sm font-semibold mb-2">Categoria</label>
                    <div class="flex items-center space-x-2">
                        <select id="Categoria" name="Categoria" required
                                class="w-full p-3  border rounded-lg focus:outline-none focus:ring-2 focus:ring-color-1">
                            {%for categoria in categorias %}
                            <option value="{{categoria.id}}">{{categoria.nome}}</option>
                            {% endfor %}
                        </select>
                       
                        
                    </div>

                </div>
                <div class="w-1/2">
                    <label for="status" class="block text-color-4 text-sm font-semibold mb-2">Status</label>
                    <div class="flex items-center space-x-2">
                        <select name="status" id="status">
                            <option value="em_estoque"> Em estoque</option>
                            <option value="em_uso">A venda </option>
                        </select>
                    </div>
                </div>
            </div>
            <button type="submit"
                class="w-full bg-color-1 text-color-3 p-3 rounded-lg hover:bg-opacity-90 transition-all">
                <i class="fas fa-plus-circle mr-2"></i> Adicionar Produto
            </button>
        </form>


        
    </div>
</div>




<!-- Modal Categoria -->
<div id="modalCategoria" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg w-auto">
        <h2 class="text-lg font-semibold mb-4">Adicionar Categoria</h2>
        <div class="w-full p-3 mb-2">
            <label for="Categoria" class="block text-color-4 text-sm font-semibold mb-2">Categoria</label>
            <div class="flex items-center space-x-2">
                <select id="Categoria" name="Categoria" required
                    class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-color-1">
                    {%for categoria in categorias %}
                    <option value="{{categoria.id}}">{{categoria.nome}}</option>
                    {% endfor %}
                </select>
        
            </div>
        </div>
        <form id="formCategoria" action="{% url 'criar_categoria' %}" method="POST"> {% csrf_token %}
            <div class="mb-4">
                <label class="block text-sm font-medium">Nome da Categoria</label>
                <input type="text" name="nomeCategoria" required
                       class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <button type="submit" class="w-full  py-2 rounded-lg ">
                Salvar
            </button>
        </form>
    </div>
</div>



{%if is_proprietario %}
<div id="modalLoja" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-8 rounded-lg w-auto">
        <h2 class="text-xl font-semibold  mb-4">Ver lojas parceiras</h2>
        <form id="formLojaView" action="{%url 'update_loja_user' %}" method="POST"> {% csrf_token %}
            <div class="m-3 p-3">
                <label for="lojas" class="block text-color-4
                 text-lg font-semibold mb-2">Lojas parceiras</label>
                <select id="lojas" name="lojas" required
                    class="w-full p-5 border rounded-lg 
                    focus:outline-none focus:ring-2 focus:ring-color-1">
                    {% for loja in lojasDoUser %}
                    <option value="{{loja.id}}" class="p-3">{{loja.nome}}</option>
                    {%endfor%}
                </select>
            </div>
            <button type="submit" class="w-full  py-2 rounded-lg ">
                Salvar
            </button>
        </form>
    </div>
</div>
{%endif%}

<script>
function buscarProduto() {
    let input = document.getElementById("searchInput").value.toLowerCase();
    let rows = document.querySelectorAll("#productTableBody tr");

    rows.forEach(row => {
        let productName = row.cells[1].innerText.toLowerCase(); // Obtém o nome do produto
        row.style.display = productName.includes(input) ? "" : "none"; // Mostra/Oculta a linha
    });
}
function openEditModal(id, nome, quantidade, tipo_quantidade, validade, categoria, estoquemin, status) {
    document.getElementById("editProductId").value = id;
    document.getElementById("editProductName").value = nome;
    document.getElementById("editProductQuantity").value = quantidade;
    document.getElementById("editProductTipoQuantidade").value = tipo_quantidade;
    document.getElementById("editProductValidade").value = validade;
    document.getElementById("editProductCategoria").value = categoria;
    console.log(estoquemin)
    document.getElementById("editProductEstoqueMin").value = estoquemin;
    document.getElementById("editProductStatus").value = status;

    document.getElementById("editProductModal").classList.remove("hidden");
    document.getElementById("editProductModal").classList.add("flex");
}

function closeEditModal() {
    document.getElementById("editProductModal").classList.add("hidden");
    document.getElementById("editProductModal").classList.remove("flex");
}


</script>

<script>
    const openModalBtn = document.getElementById('openModalBtn');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const modal = document.getElementById('productModal');
    const modalEditProduto = document.getElementById('editProductModal');

    
    // Abre o modal
    openModalBtn.addEventListener('click', () => {
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        const driver = window.driver.js.driver;

        const driverObj = driver({
            showProgress: true,
            steps: [
            {element: "#validadepop",popover: {title: "Validade",description: "Cadastre as validades dos produtos para que o sistema possa notificá-lo. Recomendamos especial atenção ao cadastro de validades para frutas e verduras, devido ao curto prazo de consumo."}},
            {element: "#estoqueMin",popover: {title: "Estoque minimo",description: "A quantidade mínima que o produto deve ter em estoque é um limite estratégico para evitar rupturas. Recomendamos definir um valor que garanta tempo suficiente para repor o estoque antes que ele se esgote completamente, considerando o tempo de entrega dos fornecedores e a demanda média do produto."}},

        
                
            ]
        });
        driverObj.drive();

    });

    // Fecha o modal ao clicar no botão de fechar
    closeModalBtn.addEventListener('click', () => {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    });

    // Fecha o modal ao clicar fora do conteúdo
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
    });

function abrirModalFornecedor() {
    document.getElementById('modalFornecedor').classList.remove('hidden');
}


function abrirModalCategoria() {
    document.getElementById('modalCategoria').classList.remove('hidden');
}
function AbrirModalLoja() {
    document.getElementById('modalLoja').classList.remove('hidden');
}
// Fechar modal ao clicar fora do formulário
window.onclick = function(event) {
    let modalFornecedor = document.getElementById('modalFornecedor');
    let modalCategoria = document.getElementById('modalCategoria');
    let modalLoja = document.getElementById('modalLoja');
    let modalTurn = document.getElementById('ModalTrun');

    if (event.target == modalFornecedor) {
        modalFornecedor.classList.add('hidden');
    }
    if (event.target == modalCategoria) {
        modalCategoria.classList.add('hidden');
    }
    if (event.target == modalLoja) {
        modalLoja.classList.add('hidden');
    }
    if (event.target == modalTurn) {
        modalTurn.classList.add('hidden');
    }
}
</script>
<script>
       const driver = window.driver.js.driver;

    const driverObj = driver({
        showProgress: true,
        steps: [
        {element: "#notificationBtn",popover: {title: "Notificação",description: "Aqui você pode ver as notificações do sistema"}},
        {element: "#botaosair",popover: {title: "Sair",description: "Aqui você pode sair do sistema"}},  
        ]
        
    });
driverObj.drive();
</script>
{% endblock %}
